// =====================================================
// نموذج المستخدم - User Model
// هذا الملف يحتوي على مخطط قاعدة البيانات للمستخدمين
// =====================================================

// استيراد مكتبة mongoose للتعامل مع MongoDB
const mongoose = require('mongoose');

// استيراد مكتبة bcryptjs لتشفير كلمات المرور
const bcrypt = require('bcryptjs');

// =====================================================
// تعريف مخطط المستخدم - User Schema Definition
// =====================================================
const userSchema = new mongoose.Schema({

    // اسم المستخدم الكامل
    name: {
        type: String, // نوع البيانات: نص
        required: [true, 'الاسم مطلوب'], // حقل إجباري مع رسالة خطأ مخصصة
        trim: true, // إزالة المسافات الزائدة
        minlength: [2, 'الاسم يجب أن يكون حرفين على الأقل'], // الحد الأدنى للطول
        maxlength: [50, 'الاسم يجب ألا يتجاوز 50 حرف'] // الحد الأقصى للطول
    },

    // البريد الإلكتروني للمستخدم
    email: {
        type: String, // نوع البيانات: نص
        required: [true, 'البريد الإلكتروني مطلوب'], // حقل إجباري
        unique: true, // يجب أن يكون فريداً (لا يتكرر)
        lowercase: true, // تحويل لأحرف صغيرة تلقائياً
        trim: true, // إزالة المسافات الزائدة
        match: [/^\S+@\S+\.\S+$/, 'البريد الإلكتروني غير صالح'] // التحقق من صيغة البريد
    },

    // كلمة المرور المشفرة
    password: {
        type: String, // نوع البيانات: نص
        required: [true, 'كلمة المرور مطلوبة'], // حقل إجباري
        minlength: [6, 'كلمة المرور يجب أن تكون 6 أحرف على الأقل'], // الحد الأدنى للطول
        select: false // لا يتم إرجاع كلمة المرور في الاستعلامات افتراضياً
    },

    // رقم الهاتف للتواصل عبر WhatsApp
    phone: {
        type: String, // نوع البيانات: نص
        required: [true, 'رقم الهاتف مطلوب'], // حقل إجباري
        trim: true // إزالة المسافات الزائدة
    },

    // دور المستخدم في النظام (تاجر أو زبون)
    role: {
        type: String, // نوع البيانات: نص
        enum: ['تاجر', 'زبون'], // القيم المسموح بها فقط
        default: 'زبون' // القيمة الافتراضية هي زبون
    },

    // هل تمت الموافقة على حساب التاجر؟
    // الزبائن موافق عليهم تلقائياً، التجار يحتاجون موافقة المدير
    isApproved: {
        type: Boolean, // نوع البيانات: منطقي
        default: true // القيمة الافتراضية: موافق عليه (سيتم تغييرها للتجار)
    },

    // هل المستخدم مدير الموقع؟
    isAdmin: {
        type: Boolean, // نوع البيانات: منطقي
        default: false // القيمة الافتراضية: ليس مديراً
    },

    // تاريخ إنشاء الحساب
    createdAt: {
        type: Date, // نوع البيانات: تاريخ
        default: Date.now // القيمة الافتراضية هي الوقت الحالي
    }
});

// =====================================================
// Middleware: تشفير كلمة المرور قبل الحفظ
// يتم تنفيذ هذا الكود تلقائياً قبل حفظ المستخدم
// =====================================================
userSchema.pre('save', async function (next) {
    // التحقق إذا تم تعديل كلمة المرور
    // إذا لم يتم تعديلها، ننتقل للخطوة التالية
    if (!this.isModified('password')) {
        return next();
    }

    // إنشاء salt للتشفير (عامل التعقيد = 12)
    const salt = await bcrypt.genSalt(12);

    // تشفير كلمة المرور باستخدام bcrypt
    this.password = await bcrypt.hash(this.password, salt);

    // الانتقال للخطوة التالية
    next();
});

// =====================================================
// Method: مقارنة كلمة المرور المدخلة مع المخزنة
// تستخدم عند تسجيل الدخول للتحقق من صحة كلمة المرور
// =====================================================
userSchema.methods.comparePassword = async function (candidatePassword) {
    // مقارنة كلمة المرور المدخلة مع المشفرة
    // ترجع true إذا تطابقت، false إذا لم تتطابق
    return await bcrypt.compare(candidatePassword, this.password);
};

// =====================================================
// إنشاء وتصدير النموذج
// =====================================================
const User = mongoose.model('User', userSchema);

// تصدير النموذج للاستخدام في ملفات أخرى
module.exports = User;
